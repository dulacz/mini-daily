<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Daily Wellness Tracker - Track your daily wellness activities">
    <title>Daily Check-in</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='app-styles.css') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', path='favicon.svg') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="wellnessApp" x-init="init()" class="dark-theme">
    <!-- Animated Background Particles -->
    <div class="particles" x-ref="particles"></div>

    <!-- Navigation -->
    <nav class="navigation">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>Task Tracker</h1>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link active">Daily Check-in</a>
                <a href="/todo" class="nav-link">Todo List</a>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">Daily Check-in</h1>
                <div class="star-counter">
                    <span class="star-icon">‚≠ê</span>
                    <span class="star-text">
                        <span class="star-number" x-text="completedToday"></span>
                        <span class="star-label">stars today</span>
                    </span>
                </div>
                <div class="streak-counter">
                    <span class="streak-icon">üî•</span>
                    <span class="streak-text">
                        <span class="streak-number" x-text="streak"></span>
                        <span class="streak-label">day streak</span>
                    </span>
                </div>
                <div class="star-counter">
                    <span class="star-icon">‚≠ê</span>
                    <span class="star-text">
                        <span class="star-number" x-text="totalStars365"></span>
                        <span class="star-label">total stars</span>
                    </span>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div x-show="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading activities...</p>
        </div>

        <!-- Error State -->
        <div x-show="error" class="error-state">
            <p x-text="error"></p>
            <button @click="init()" class="retry-btn">Retry</button>
        </div>

        <!-- Main Content -->
        <section class="main-content" x-show="!loading && !error">
            <!-- Knowledge Task Box -->
            <div class="task-card">
                <div class="task-header">
                    <h3 class="task-title">üìö Knowledge</h3>
                    <div class="task-stats">
                        <span class="star-icon">‚≠ê</span>
                        <span class="star-number" x-text="getTaskCompletedCount('knowledge')"></span>
                        <span class="star-label">/ 9 activities</span>
                    </div>
                </div>
                <div class="activity-grid">
                    <template x-for="activity in getTaskActivities('knowledge')" :key="activity.key">
                        <button class="activity-btn-grid" :class="{ 'active': activity.completed }"
                            @click="toggleActivity(activity.task, activity.activity)">
                            <div class="activity-label" x-text="activity.label"></div>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Fitness Task Box -->
            <div class="task-card">
                <div class="task-header">
                    <h3 class="task-title">üí™ Fitness</h3>
                    <div class="task-stats">
                        <span class="star-icon">‚≠ê</span>
                        <span class="star-number" x-text="getTaskCompletedCount('fitness')"></span>
                        <span class="star-label">/ 9 activities</span>
                    </div>
                </div>
                <div class="activity-grid">
                    <template x-for="activity in getTaskActivities('fitness')" :key="activity.key">
                        <button class="activity-btn-grid" :class="{ 'active': activity.completed }"
                            @click="toggleActivity(activity.task, activity.activity)">
                            <div class="activity-label" x-text="activity.label"></div>
                        </button>
                    </template>
                </div>
            </div>

            <!-- Creativity Task Box -->
            <div class="task-card">
                <div class="task-header">
                    <h3 class="task-title">üé® Creativity</h3>
                    <div class="task-stats">
                        <span class="star-icon">‚≠ê</span>
                        <span class="star-number" x-text="getTaskCompletedCount('creativity')"></span>
                        <span class="star-label">/ 9 activities</span>
                    </div>
                </div>
                <div class="activity-grid">
                    <template x-for="activity in getTaskActivities('creativity')" :key="activity.key">
                        <button class="activity-btn-grid" :class="{ 'active': activity.completed }"
                            @click="toggleActivity(activity.task, activity.activity)">
                            <div class="activity-label" x-text="activity.label"></div>
                        </button>
                    </template>
                </div>
            </div>
        </section>

        <!-- Historical Calendar -->
        <section class="history-section" x-show="!loading && !error">
            <div class="history-header">
                <h2 class="history-title">Activity History</h2>
                <div class="month-navigation">
                    <button class="month-nav-btn" @click="previousMonth()">‚Üê</button>
                    <span class="current-month" x-text="currentMonthDisplay"></span>
                    <button class="month-nav-btn" @click="nextMonth()">‚Üí</button>
                </div>
            </div>
            <div class="calendar-grid" x-html="calendarHtml"></div>
        </section>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('wellnessApp', () => ({
                // Core state
                activities: [],
                config: null,
                loading: true,
                error: null,

                // Display state
                streak: 0,
                totalStars365: 0,

                // Calendar state
                currentMonth: new Date().getMonth(),
                currentYear: new Date().getFullYear(),
                calendarHtml: '',

                async init() {
                    console.log('Initializing Wellness Tracker...');
                    try {
                        await this.loadConfig();
                        await this.loadData();
                        await this.updateStats();
                        await this.renderCalendar();
                    } catch (error) {
                        console.error('Initialization error:', error);
                        this.error = 'Failed to load application: ' + error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async loadConfig() {
                    const response = await fetch('/api/config');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    this.config = data.user_configs.alice;

                    // Build activities array
                    this.activities = [];
                    Object.keys(this.config.tasks).forEach(taskId => {
                        const task = this.config.tasks[taskId];
                        Object.keys(task.activities).forEach(activityId => {
                            this.activities.push({
                                key: `${taskId}_${activityId}`,
                                task: taskId,
                                activity: activityId,
                                label: task.activities[activityId].label,
                                taskTitle: task.title,
                                completed: false
                            });
                        });
                    });

                    console.log('Config loaded, activities:', this.activities.length);
                },

                async loadData() {
                    const response = await fetch('/api/day/completions');
                    if (response.ok) {
                        const data = await response.json();
                        const completions = data.completions || {};

                        // Update activity completion status
                        this.activities.forEach(activity => {
                            const taskCompletions = completions[activity.task] || {};
                            activity.completed = taskCompletions[activity.activity] || false;
                        });
                    }
                },

                async toggleActivity(task, activity) {
                    const activityObj = this.activities.find(a => a.task === task && a.activity === activity);
                    if (!activityObj) return;

                    // Toggle completion
                    activityObj.completed = !activityObj.completed;

                    // Save to backend
                    try {
                        const response = await fetch('/api/activity/toggle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                task: task,
                                activity: activity,
                                completed: activityObj.completed
                            })
                        });

                        if (!response.ok) {
                            // Revert on error
                            activityObj.completed = !activityObj.completed;
                        } else {
                            await this.updateStats();
                            await this.renderCalendar();
                        }
                    } catch (error) {
                        console.error('Error saving activity:', error);
                        // Revert on error
                        activityObj.completed = !activityObj.completed;
                    }
                },

                async updateStats() {
                    try {
                        const response = await fetch('/api/stats');
                        if (response.ok) {
                            const stats = await response.json();
                            this.streak = stats.streak || 0;
                            this.totalStars365 = stats.total_stars_365 || 0;
                        }
                    } catch (error) {
                        console.error('Error updating stats:', error);
                    }
                },

                async renderCalendar() {
                    try {
                        const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                        const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                        const daysInMonth = lastDay.getDate();
                        const startingDayOfWeek = firstDay.getDay();

                        const response = await fetch('/api/history?days=365');
                        if (!response.ok) throw new Error('Failed to fetch history');

                        const data = await response.json();
                        const historyMap = data.history || {};

                        const todayDateStr = new Date().toISOString().split('T')[0];
                        let html = '';

                        const totalCells = Math.ceil((daysInMonth + startingDayOfWeek) / 7) * 7;

                        for (let i = 0; i < totalCells; i++) {
                            const dayNumber = i - startingDayOfWeek + 1;

                            if (dayNumber <= 0 || dayNumber > daysInMonth) {
                                html += '<div class="day-cell outside-month"></div>';
                            } else {
                                const date = new Date(this.currentYear, this.currentMonth, dayNumber);
                                const dateStr = date.toISOString().split('T')[0];
                                const dayData = historyMap[dateStr];

                                let totalCompleted = 0;
                                if (dayData) {
                                    // dayData is like {'creativity': 9, 'fitness': 10, 'knowledge': 8}
                                    // Sum up all the completion counts
                                    Object.values(dayData).forEach(count => {
                                        if (typeof count === 'number') {
                                            totalCompleted += count;
                                        }
                                    });
                                }

                                let levelClass = 'level-0';
                                if (totalCompleted >= 20) levelClass = 'level-3';
                                else if (totalCompleted >= 10) levelClass = 'level-2';
                                else if (totalCompleted >= 5) levelClass = 'level-1';

                                const isToday = dateStr === todayDateStr ? 'today' : '';

                                html += `<div class="day-cell ${levelClass} ${isToday}">
                                    <div class="day-number">${dayNumber}</div>
                                    ${totalCompleted > 0 ? `<div class="day-stars">‚≠ê${totalCompleted}</div>` : ''}
                                </div>`;
                            }
                        }

                        this.calendarHtml = html;
                    } catch (error) {
                        console.error('Error rendering calendar:', error);
                        this.calendarHtml = '<div class="error-state">Failed to load calendar</div>';
                    }
                },

                previousMonth() {
                    if (this.currentMonth === 0) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth--;
                    }
                    this.renderCalendar();
                },

                nextMonth() {
                    if (this.currentMonth === 11) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth++;
                    }
                    this.renderCalendar();
                },

                getTaskActivities(taskId) {
                    return this.activities.filter(a => a.task === taskId);
                },

                getTaskCompletedCount(taskId) {
                    return this.activities.filter(a => a.task === taskId && a.completed).length;
                },

                get completedToday() {
                    return this.activities.filter(a => a.completed).length;
                },

                get completionPercentage() {
                    if (this.activities.length === 0) return 0;
                    return (this.completedToday / this.activities.length) * 100;
                },

                get currentMonthDisplay() {
                    const date = new Date(this.currentYear, this.currentMonth);
                    return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                }
            }));
        });
    </script>
</body>

</html>